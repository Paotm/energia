"use strict";

d3.sankey = function () {

  var sankey = {},
      nodeWidth = 24,
      nodeSpacing = 8,
      size = [1, 1],
      nodes = [],
      links = [],
      defaultLinkCurvature = 0.5;

  sankey.nodeWidth = function (_) {
    if (!arguments.length) {
      return nodeWidth;
    }
    nodeWidth = +_;
    return sankey;
  };

  sankey.nodeSpacing = function (_) {
    if (!arguments.length) {
      return nodeSpacing;
    }
    nodeSpacing = +_;
    return sankey;
  };

  sankey.nodes = function (_) {
    if (!arguments.length) {
      return nodes;
    }
    nodes = _;
    return sankey;
  };

  sankey.links = function (_) {
    if (!arguments.length) {
      return links;
    }
    links = _;
    return sankey;
  };

  sankey.size = function (_) {
    if (!arguments.length) {
      return size;
    }
    size = _;
    return sankey;
  };

  sankey.layout = function (iterations) {
    computeNodeLinks();
    computeNodeValues();
    computeNodeBreadths();
    computeNodeDepths(iterations);
    computeLinkDepths();
    return sankey;
  };

  sankey.relayout = function () {
    computeLinkDepths();
    return sankey;
  };

  sankey.link = function () {
    var curvature = .5;

    function link(d) {
      var x0 = d.source.x + d.source.dx,
          x1 = d.target.x,
          xi = d3.interpolateNumber(x0, x1),
          x2 = xi(curvature),
          x3 = xi(1 - curvature),
          y0 = d.source.y + d.sy + d.dy / 2,
          y1 = d.target.y + d.ty + d.dy / 2;
      return "M" + x0 + "," + y0 + "C" + x2 + "," + y0 + " " + x3 + "," + y1 + " " + x1 + "," + y1;
    }

    link.curvature = function (_) {
      if (!arguments.length) {
        return curvature;
      }
      curvature = +_;
      return link;
    };

    return link;
  };

  // Populate the sourceLinks and targetLinks for each node.
  // Also, if the source and target are not objects, assume they are indices.
  function computeNodeLinks() {
    nodes.forEach(function (node) {
      node.sourceLinks = [];
      node.targetLinks = [];
    });
    links.forEach(function (link) {
      var source = link.source,
          target = link.target;
      if (typeof source === "number") source = link.source = nodes[link.source];
      if (typeof target === "number") target = link.target = nodes[link.target];
      source.sourceLinks.push(link);
      target.targetLinks.push(link);
    });
  }

  // Compute the value (size) of each node by summing the associated links.
  function computeNodeValues() {
    nodes.forEach(function (node) {
      node.value = Math.max(d3.sum(node.sourceLinks, value), d3.sum(node.targetLinks, value));
    });
  }

  // Iteratively assign the breadth (x-position) for each node.
  // Nodes are assigned the maximum breadth of incoming neighbors plus one;
  // nodes with no incoming links are assigned breadth zero, while
  // nodes with no outgoing links are assigned the maximum breadth.
  // function computeNodeBreadths() {
  //   var remainingNodes = nodes,
  //       nextNodes,
  //       x = 0;
  //
  //   while (remainingNodes.length) {
  //     nextNodes = [];
  //     remainingNodes.forEach(function(node) {
  //       node.x = x;
  //       node.dx = nodeWidth;
  //       node.sourceLinks.forEach(function(link) {
  //         if (nextNodes.indexOf(link.target) < 0) {
  //           nextNodes.push(link.target);
  //         }
  //       });
  //     });
  //     remainingNodes = nextNodes;
  //     ++x;
  //   }
  //
  //   //
  //   moveSinksRight(x);
  //   scaleNodeBreadths((size[0] - nodeWidth) / (x - 1));
  // }                                          // CÃ³digo alterado
  function computeNodeBreadths() {
    var remainingNodes = nodes,
        nextNodes,
        x = 0;

    while (remainingNodes.length) {
      nextNodes = [];
      remainingNodes.forEach(function (node) {

        if (node.xPos) node.x = node.xPos;else node.x = x;

        node.dx = nodeWidth;
        node.sourceLinks.forEach(function (link) {
          nextNodes.push(link.target);
        });
      });
      remainingNodes = nextNodes;
      ++x;
    }

    // moveSinksRight(x);
    scaleNodeBreadths((size[0] - nodeWidth) / (x - 1));
  }

  function moveSourcesRight() {
    nodes.forEach(function (node) {
      if (!node.targetLinks.length) {
        node.x = d3.min(node.sourceLinks, function (d) {
          return d.target.x;
        }) - 1;
      }
    });
  }

  function moveSinksRight(x) {
    nodes.forEach(function (node) {
      if (!node.sourceLinks.length) {
        node.x = x - 1;
      }
    });
  }

  function scaleNodeBreadths(kx) {
    nodes.forEach(function (node) {
      node.x *= kx;
    });
  }

  function computeNodeDepths(iterations) {
    var nodesByBreadth = d3.nest().key(function (d) {
      return d.x;
    }).sortKeys(d3.ascending).entries(nodes).map(function (d) {
      return d.values;
    });

    //
    initializeNodeDepth();
    resolveCollisions();
    for (var alpha = 1; iterations > 0; --iterations) {
      relaxRightToLeft(alpha *= .99);
      resolveCollisions();
      relaxLeftToRight(alpha);
      resolveCollisions();
    }

    function initializeNodeDepth() {
      var ky = d3.min(nodesByBreadth, function (nodes) {
        return (size[1] - (nodes.length - 1) * nodeSpacing) / d3.sum(nodes, value);
      });

      nodesByBreadth.forEach(function (nodes) {
        nodes.forEach(function (node, i) {
          node.y = i;
          node.dy = node.value * ky;
        });
      });

      links.forEach(function (link) {
        link.dy = link.value * ky;
      });
    }

    function relaxLeftToRight(alpha) {
      nodesByBreadth.forEach(function (nodes, breadth) {
        nodes.forEach(function (node) {
          if (node.targetLinks.length) {
            var y = d3.sum(node.targetLinks, weightedSource) / d3.sum(node.targetLinks, value);
            node.y += (y - center(node)) * alpha;
          }
        });
      });

      function weightedSource(link) {
        return center(link.source) * link.value;
      }
    }

    function relaxRightToLeft(alpha) {
      nodesByBreadth.slice().reverse().forEach(function (nodes) {
        nodes.forEach(function (node) {
          if (node.sourceLinks.length) {
            var y = d3.sum(node.sourceLinks, weightedTarget) / d3.sum(node.sourceLinks, value);
            node.y += (y - center(node)) * alpha;
          }
        });
      });

      function weightedTarget(link) {
        return center(link.target) * link.value;
      }
    }

    function resolveCollisions() {
      nodesByBreadth.forEach(function (nodes) {
        var node,
            dy,
            y0 = 0,
            n = nodes.length,
            i;

        // Push any overlapping nodes down.
        nodes.sort(ascendingDepth);
        for (i = 0; i < n; ++i) {
          node = nodes[i];
          dy = y0 - node.y;
          if (dy > 0) node.y += dy;
          y0 = node.y + node.dy + nodeSpacing;
        }

        // If the bottommost node goes outside the bounds, push it back up.
        dy = y0 - nodeSpacing - size[1];
        if (dy > 0) {
          y0 = node.y -= dy;

          // Push any overlapping nodes back up.
          for (i = n - 2; i >= 0; --i) {
            node = nodes[i];
            dy = node.y + node.dy + nodeSpacing - y0;
            if (dy > 0) node.y -= dy;
            y0 = node.y;
          }
        }
      });
    }

    function ascendingDepth(a, b) {
      return a.y - b.y;
    }
  }

  function computeLinkDepths() {
    nodes.forEach(function (node) {
      node.sourceLinks.sort(ascendingTargetDepth);
      node.targetLinks.sort(ascendingSourceDepth);
    });
    nodes.forEach(function (node) {
      var sy = 0,
          ty = 0;
      node.sourceLinks.forEach(function (link) {
        link.sy = sy;
        sy += link.dy;
      });
      node.targetLinks.forEach(function (link) {
        link.ty = ty;
        ty += link.dy;
      });
    });

    function ascendingSourceDepth(a, b) {
      return a.source.y - b.source.y;
    }

    function ascendingTargetDepth(a, b) {
      return a.target.y - b.target.y;
    }
  }

  function center(node) {
    return node.y + node.dy / 2;
  }

  function value(link) {
    return link.value;
  }

  return sankey;
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImQzLXNhbmtleS5qcyJdLCJuYW1lcyI6WyJkMyIsInNhbmtleSIsIm5vZGVXaWR0aCIsIm5vZGVTcGFjaW5nIiwic2l6ZSIsIm5vZGVzIiwibGlua3MiLCJkZWZhdWx0TGlua0N1cnZhdHVyZSIsIl8iLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJsYXlvdXQiLCJpdGVyYXRpb25zIiwiY29tcHV0ZU5vZGVMaW5rcyIsImNvbXB1dGVOb2RlVmFsdWVzIiwiY29tcHV0ZU5vZGVCcmVhZHRocyIsImNvbXB1dGVOb2RlRGVwdGhzIiwiY29tcHV0ZUxpbmtEZXB0aHMiLCJyZWxheW91dCIsImxpbmsiLCJjdXJ2YXR1cmUiLCJkIiwieDAiLCJzb3VyY2UiLCJ4IiwiZHgiLCJ4MSIsInRhcmdldCIsInhpIiwiaW50ZXJwb2xhdGVOdW1iZXIiLCJ4MiIsIngzIiwieTAiLCJ5Iiwic3kiLCJkeSIsInkxIiwidHkiLCJmb3JFYWNoIiwibm9kZSIsInNvdXJjZUxpbmtzIiwidGFyZ2V0TGlua3MiLCJwdXNoIiwidmFsdWUiLCJNYXRoIiwibWF4Iiwic3VtIiwicmVtYWluaW5nTm9kZXMiLCJuZXh0Tm9kZXMiLCJ4UG9zIiwic2NhbGVOb2RlQnJlYWR0aHMiLCJtb3ZlU291cmNlc1JpZ2h0IiwibWluIiwibW92ZVNpbmtzUmlnaHQiLCJreCIsIm5vZGVzQnlCcmVhZHRoIiwibmVzdCIsImtleSIsInNvcnRLZXlzIiwiYXNjZW5kaW5nIiwiZW50cmllcyIsIm1hcCIsInZhbHVlcyIsImluaXRpYWxpemVOb2RlRGVwdGgiLCJyZXNvbHZlQ29sbGlzaW9ucyIsImFscGhhIiwicmVsYXhSaWdodFRvTGVmdCIsInJlbGF4TGVmdFRvUmlnaHQiLCJreSIsImkiLCJicmVhZHRoIiwid2VpZ2h0ZWRTb3VyY2UiLCJjZW50ZXIiLCJzbGljZSIsInJldmVyc2UiLCJ3ZWlnaHRlZFRhcmdldCIsIm4iLCJzb3J0IiwiYXNjZW5kaW5nRGVwdGgiLCJhIiwiYiIsImFzY2VuZGluZ1RhcmdldERl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TCxHQUFVQSxFQUFWO0FBQ0FBLGNBQU1mLEtBQUtnQixFQUFYO0FBQ0QsT0FIRDtBQUlBSSxXQUFLRSxXQUFMLENBQWlCSCxPQUFqQixDQUF5QixVQUFTbkIsSUFBVCxFQUFlO0FBQ3RDQSxhQUFLa0IsRUFBTCxHQUFVQSxFQUFWO0FBQ0FBLGNBQU1sQixLQUFLZ0IsRUFBWDtBQUNELE9BSEQ7QUFJRCxLQVZEOztBQVlBLGFBQVMrQyxvQkFBVCxDQUE4QkgsQ0FBOUIsRUFBaUNDLENBQWpDLEVBQW9DO0FBQ2xDLGFBQU9ELEVBQUV4RCxNQUFGLENBQVNVLENBQVQsR0FBYStDLEVBQUV6RCxNQUFGLENBQVNVLENBQTdCO0FBQ0Q7O0FBRUQsYUFBU2dELG9CQUFULENBQThCRixDQUE5QixFQUFpQ0MsQ0FBakMsRUFBb0M7QUFDbEMsYUFBT0QsRUFBRXBELE1BQUYsQ0FBU00sQ0FBVCxHQUFhK0MsRUFBRXJELE1BQUYsQ0FBU00sQ0FBN0I7QUFDRDtBQUNGOztBQUVELFdBQVN1QyxNQUFULENBQWdCakMsSUFBaEIsRUFBc0I7QUFDcEIsV0FBT0EsS0FBS04sQ0FBTCxHQUFTTSxLQUFLSixFQUFMLEdBQVUsQ0FBMUI7QUFDRDs7QUFFRCxXQUFTUSxLQUFULENBQWV4QixJQUFmLEVBQXFCO0FBQ25CLFdBQU9BLEtBQUt3QixLQUFaO0FBQ0Q7O0FBRUQsU0FBTzFDLE1BQVA7QUFDRCxDQWpVRCIsImZpbGUiOiJkMy1zYW5rZXkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJkMy5zYW5rZXkgPSBmdW5jdGlvbigpIHtcblxuICBsZXQgc2Fua2V5ID0ge31cbiAgICAsIG5vZGVXaWR0aCA9IDI0XG4gICAgLCBub2RlU3BhY2luZyA9IDhcbiAgICAsIHNpemUgPSBbMSwgMV1cbiAgICAsIG5vZGVzID0gW11cbiAgICAsIGxpbmtzID0gW11cbiAgICAsIGRlZmF1bHRMaW5rQ3VydmF0dXJlID0gMC41O1xuXG4gIHNhbmtleS5ub2RlV2lkdGggPSBmdW5jdGlvbihfKSB7XG4gICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7IHJldHVybiBub2RlV2lkdGg7IH1cbiAgICBub2RlV2lkdGggPSArXztcbiAgICByZXR1cm4gc2Fua2V5O1xuICB9O1xuXG4gIHNhbmtleS5ub2RlU3BhY2luZyA9IGZ1bmN0aW9uKF8pIHtcbiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgcmV0dXJuIG5vZGVTcGFjaW5nOyB9XG4gICAgbm9kZVNwYWNpbmcgPSArXztcbiAgICByZXR1cm4gc2Fua2V5O1xuICB9O1xuXG4gIHNhbmtleS5ub2RlcyA9IGZ1bmN0aW9uKF8pIHtcbiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgcmV0dXJuIG5vZGVzOyB9XG4gICAgbm9kZXMgPSBfO1xuICAgIHJldHVybiBzYW5rZXk7XG4gIH07XG5cbiAgc2Fua2V5LmxpbmtzID0gZnVuY3Rpb24oXykge1xuICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgeyByZXR1cm4gbGlua3M7IH1cbiAgICBsaW5rcyA9IF87XG4gICAgcmV0dXJuIHNhbmtleTtcbiAgfTtcblxuICBzYW5rZXkuc2l6ZSA9IGZ1bmN0aW9uKF8pIHtcbiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgcmV0dXJuIHNpemU7IH1cbiAgICBzaXplID0gXztcbiAgICByZXR1cm4gc2Fua2V5O1xuICB9O1xuXG4gIHNhbmtleS5sYXlvdXQgPSBmdW5jdGlvbihpdGVyYXRpb25zKSB7XG4gICAgY29tcHV0ZU5vZGVMaW5rcygpO1xuICAgIGNvbXB1dGVOb2RlVmFsdWVzKCk7XG4gICAgY29tcHV0ZU5vZGVCcmVhZHRocygpO1xuICAgIGNvbXB1dGVOb2RlRGVwdGhzKGl0ZXJhdGlvbnMpO1xuICAgIGNvbXB1dGVMaW5rRGVwdGhzKCk7XG4gICAgcmV0dXJuIHNhbmtleTtcbiAgfTtcblxuICBzYW5rZXkucmVsYXlvdXQgPSBmdW5jdGlvbigpIHtcbiAgICBjb21wdXRlTGlua0RlcHRocygpO1xuICAgIHJldHVybiBzYW5rZXk7XG4gIH07XG5cbiAgc2Fua2V5LmxpbmsgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgY3VydmF0dXJlID0gLjU7XG5cbiAgICBmdW5jdGlvbiBsaW5rKGQpIHtcbiAgICAgIHZhciB4MCA9IGQuc291cmNlLnggKyBkLnNvdXJjZS5keCxcbiAgICAgICAgICB4MSA9IGQudGFyZ2V0LngsXG4gICAgICAgICAgeGkgPSBkMy5pbnRlcnBvbGF0ZU51bWJlcih4MCwgeDEpLFxuICAgICAgICAgIHgyID0geGkoY3VydmF0dXJlKSxcbiAgICAgICAgICB4MyA9IHhpKDEgLSBjdXJ2YXR1cmUpLFxuICAgICAgICAgIHkwID0gZC5zb3VyY2UueSArIGQuc3kgKyBkLmR5IC8gMixcbiAgICAgICAgICB5MSA9IGQudGFyZ2V0LnkgKyBkLnR5ICsgZC5keSAvIDI7XG4gICAgICByZXR1cm4gXCJNXCIgKyB4MCArIFwiLFwiICsgeTBcbiAgICAgICAgICAgKyBcIkNcIiArIHgyICsgXCIsXCIgKyB5MFxuICAgICAgICAgICArIFwiIFwiICsgeDMgKyBcIixcIiArIHkxXG4gICAgICAgICAgICsgXCIgXCIgKyB4MSArIFwiLFwiICsgeTE7XG4gICAgfVxuXG4gICAgbGluay5jdXJ2YXR1cmUgPSBmdW5jdGlvbihfKSB7XG4gICAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgcmV0dXJuIGN1cnZhdHVyZTsgfVxuICAgICAgY3VydmF0dXJlID0gK187XG4gICAgICByZXR1cm4gbGluaztcbiAgICB9O1xuXG4gICAgcmV0dXJuIGxpbms7XG4gIH07XG5cbiAgLy8gUG9wdWxhdGUgdGhlIHNvdXJjZUxpbmtzIGFuZCB0YXJnZXRMaW5rcyBmb3IgZWFjaCBub2RlLlxuICAvLyBBbHNvLCBpZiB0aGUgc291cmNlIGFuZCB0YXJnZXQgYXJlIG5vdCBvYmplY3RzLCBhc3N1bWUgdGhleSBhcmUgaW5kaWNlcy5cbiAgZnVuY3Rpb24gY29tcHV0ZU5vZGVMaW5rcygpIHtcbiAgICBub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHtcbiAgICAgIG5vZGUuc291cmNlTGlua3MgPSBbXTtcbiAgICAgIG5vZGUudGFyZ2V0TGlua3MgPSBbXTtcbiAgICB9KTtcbiAgICBsaW5rcy5mb3JFYWNoKGZ1bmN0aW9uKGxpbmspIHtcbiAgICAgIHZhciBzb3VyY2UgPSBsaW5rLnNvdXJjZSxcbiAgICAgICAgICB0YXJnZXQgPSBsaW5rLnRhcmdldDtcbiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09PSBcIm51bWJlclwiKSBzb3VyY2UgPSBsaW5rLnNvdXJjZSA9IG5vZGVzW2xpbmsuc291cmNlXTtcbiAgICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSBcIm51bWJlclwiKSB0YXJnZXQgPSBsaW5rLnRhcmdldCA9IG5vZGVzW2xpbmsudGFyZ2V0XTtcbiAgICAgIHNvdXJjZS5zb3VyY2VMaW5rcy5wdXNoKGxpbmspO1xuICAgICAgdGFyZ2V0LnRhcmdldExpbmtzLnB1c2gobGluayk7XG4gICAgfSk7XG4gIH1cblxuICAvLyBDb21wdXRlIHRoZSB2YWx1ZSAoc2l6ZSkgb2YgZWFjaCBub2RlIGJ5IHN1bW1pbmcgdGhlIGFzc29jaWF0ZWQgbGlua3MuXG4gIGZ1bmN0aW9uIGNvbXB1dGVOb2RlVmFsdWVzKCkge1xuICAgIG5vZGVzLmZvckVhY2goZnVuY3Rpb24obm9kZSkge1xuICAgICAgbm9kZS52YWx1ZSA9IE1hdGgubWF4KFxuICAgICAgICBkMy5zdW0obm9kZS5zb3VyY2VMaW5rcywgdmFsdWUpLFxuICAgICAgICBkMy5zdW0obm9kZS50YXJnZXRMaW5rcywgdmFsdWUpXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gSXRlcmF0aXZlbHkgYXNzaWduIHRoZSBicmVhZHRoICh4LXBvc2l0aW9uKSBmb3IgZWFjaCBub2RlLlxuICAvLyBOb2RlcyBhcmUgYXNzaWduZWQgdGhlIG1heGltdW0gYnJlYWR0aCBvZiBpbmNvbWluZyBuZWlnaGJvcnMgcGx1cyBvbmU7XG4gIC8vIG5vZGVzIHdpdGggbm8gaW5jb21pbmcgbGlua3MgYXJlIGFzc2lnbmVkIGJyZWFkdGggemVybywgd2hpbGVcbiAgLy8gbm9kZXMgd2l0aCBubyBvdXRnb2luZyBsaW5rcyBhcmUgYXNzaWduZWQgdGhlIG1heGltdW0gYnJlYWR0aC5cbiAgLy8gZnVuY3Rpb24gY29tcHV0ZU5vZGVCcmVhZHRocygpIHtcbiAgLy8gICB2YXIgcmVtYWluaW5nTm9kZXMgPSBub2RlcyxcbiAgLy8gICAgICAgbmV4dE5vZGVzLFxuICAvLyAgICAgICB4ID0gMDtcbiAgLy9cbiAgLy8gICB3aGlsZSAocmVtYWluaW5nTm9kZXMubGVuZ3RoKSB7XG4gIC8vICAgICBuZXh0Tm9kZXMgPSBbXTtcbiAgLy8gICAgIHJlbWFpbmluZ05vZGVzLmZvckVhY2goZnVuY3Rpb24obm9kZSkge1xuICAvLyAgICAgICBub2RlLnggPSB4O1xuICAvLyAgICAgICBub2RlLmR4ID0gbm9kZVdpZHRoO1xuICAvLyAgICAgICBub2RlLnNvdXJjZUxpbmtzLmZvckVhY2goZnVuY3Rpb24obGluaykge1xuICAvLyAgICAgICAgIGlmIChuZXh0Tm9kZXMuaW5kZXhPZihsaW5rLnRhcmdldCkgPCAwKSB7XG4gIC8vICAgICAgICAgICBuZXh0Tm9kZXMucHVzaChsaW5rLnRhcmdldCk7XG4gIC8vICAgICAgICAgfVxuICAvLyAgICAgICB9KTtcbiAgLy8gICAgIH0pO1xuICAvLyAgICAgcmVtYWluaW5nTm9kZXMgPSBuZXh0Tm9kZXM7XG4gIC8vICAgICArK3g7XG4gIC8vICAgfVxuICAvL1xuICAvLyAgIC8vXG4gIC8vICAgbW92ZVNpbmtzUmlnaHQoeCk7XG4gIC8vICAgc2NhbGVOb2RlQnJlYWR0aHMoKHNpemVbMF0gLSBub2RlV2lkdGgpIC8gKHggLSAxKSk7XG4gIC8vIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDw7NkaWdvIGFsdGVyYWRvXG4gIGZ1bmN0aW9uIGNvbXB1dGVOb2RlQnJlYWR0aHMoKSB7XG4gICAgICB2YXIgcmVtYWluaW5nTm9kZXMgPSBub2RlcyxcbiAgICAgICAgICBuZXh0Tm9kZXMsXG4gICAgICAgICAgeCA9IDA7XG5cbiAgICAgIHdoaWxlIChyZW1haW5pbmdOb2Rlcy5sZW5ndGgpIHtcbiAgICAgICAgbmV4dE5vZGVzID0gW107XG4gICAgICAgIHJlbWFpbmluZ05vZGVzLmZvckVhY2goZnVuY3Rpb24obm9kZSkge1xuXG4gICAgICAgICAgaWYgKG5vZGUueFBvcylcbiAgICAgICAgICAgICAgbm9kZS54ID0gbm9kZS54UG9zO1xuICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgbm9kZS54ID0geDtcblxuICAgICAgICAgIG5vZGUuZHggPSBub2RlV2lkdGg7XG4gICAgICAgICAgbm9kZS5zb3VyY2VMaW5rcy5mb3JFYWNoKGZ1bmN0aW9uKGxpbmspIHtcbiAgICAgICAgICAgIG5leHROb2Rlcy5wdXNoKGxpbmsudGFyZ2V0KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJlbWFpbmluZ05vZGVzID0gbmV4dE5vZGVzO1xuICAgICAgICArK3g7XG4gICAgICB9XG5cbiAgICAgIC8vIG1vdmVTaW5rc1JpZ2h0KHgpO1xuICAgICAgc2NhbGVOb2RlQnJlYWR0aHMoKHNpemVbMF0gLSBub2RlV2lkdGgpIC8gKHggLSAxKSk7XG4gIH1cblxuICBmdW5jdGlvbiBtb3ZlU291cmNlc1JpZ2h0KCkge1xuICAgIG5vZGVzLmZvckVhY2goZnVuY3Rpb24obm9kZSkge1xuICAgICAgaWYgKCFub2RlLnRhcmdldExpbmtzLmxlbmd0aCkge1xuICAgICAgICBub2RlLnggPSBkMy5taW4obm9kZS5zb3VyY2VMaW5rcywgZnVuY3Rpb24oZCkgeyByZXR1cm4gZC50YXJnZXQueDsgfSkgLSAxO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gbW92ZVNpbmtzUmlnaHQoeCkge1xuICAgIG5vZGVzLmZvckVhY2goZnVuY3Rpb24obm9kZSkge1xuICAgICAgaWYgKCFub2RlLnNvdXJjZUxpbmtzLmxlbmd0aCkge1xuICAgICAgICBub2RlLnggPSB4IC0gMTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHNjYWxlTm9kZUJyZWFkdGhzKGt4KSB7XG4gICAgbm9kZXMuZm9yRWFjaChmdW5jdGlvbihub2RlKSB7XG4gICAgICBub2RlLnggKj0ga3g7XG4gICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBjb21wdXRlTm9kZURlcHRocyhpdGVyYXRpb25zKSB7XG4gICAgdmFyIG5vZGVzQnlCcmVhZHRoID0gZDMubmVzdCgpXG4gICAgICAgIC5rZXkoZnVuY3Rpb24oZCkgeyByZXR1cm4gZC54OyB9KVxuICAgICAgICAuc29ydEtleXMoZDMuYXNjZW5kaW5nKVxuICAgICAgICAuZW50cmllcyhub2RlcylcbiAgICAgICAgLm1hcChmdW5jdGlvbihkKSB7IHJldHVybiBkLnZhbHVlczsgfSk7XG5cbiAgICAvL1xuICAgIGluaXRpYWxpemVOb2RlRGVwdGgoKTtcbiAgICByZXNvbHZlQ29sbGlzaW9ucygpO1xuICAgIGZvciAodmFyIGFscGhhID0gMTsgaXRlcmF0aW9ucyA+IDA7IC0taXRlcmF0aW9ucykge1xuICAgICAgcmVsYXhSaWdodFRvTGVmdChhbHBoYSAqPSAuOTkpO1xuICAgICAgcmVzb2x2ZUNvbGxpc2lvbnMoKTtcbiAgICAgIHJlbGF4TGVmdFRvUmlnaHQoYWxwaGEpO1xuICAgICAgcmVzb2x2ZUNvbGxpc2lvbnMoKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBpbml0aWFsaXplTm9kZURlcHRoKCkge1xuICAgICAgdmFyIGt5ID0gZDMubWluKG5vZGVzQnlCcmVhZHRoLCBmdW5jdGlvbihub2Rlcykge1xuICAgICAgICByZXR1cm4gKHNpemVbMV0gLSAobm9kZXMubGVuZ3RoIC0gMSkgKiBub2RlU3BhY2luZykgLyBkMy5zdW0obm9kZXMsIHZhbHVlKTtcbiAgICAgIH0pO1xuXG4gICAgICBub2Rlc0J5QnJlYWR0aC5mb3JFYWNoKGZ1bmN0aW9uKG5vZGVzKSB7XG4gICAgICAgIG5vZGVzLmZvckVhY2goZnVuY3Rpb24obm9kZSwgaSkge1xuICAgICAgICAgIG5vZGUueSA9IGk7XG4gICAgICAgICAgbm9kZS5keSA9IG5vZGUudmFsdWUgKiBreTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgbGlua3MuZm9yRWFjaChmdW5jdGlvbihsaW5rKSB7XG4gICAgICAgIGxpbmsuZHkgPSBsaW5rLnZhbHVlICoga3k7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiByZWxheExlZnRUb1JpZ2h0KGFscGhhKSB7XG4gICAgICBub2Rlc0J5QnJlYWR0aC5mb3JFYWNoKGZ1bmN0aW9uKG5vZGVzLCBicmVhZHRoKSB7XG4gICAgICAgIG5vZGVzLmZvckVhY2goZnVuY3Rpb24obm9kZSkge1xuICAgICAgICAgIGlmIChub2RlLnRhcmdldExpbmtzLmxlbmd0aCkge1xuICAgICAgICAgICAgdmFyIHkgPSBkMy5zdW0obm9kZS50YXJnZXRMaW5rcywgd2VpZ2h0ZWRTb3VyY2UpIC8gZDMuc3VtKG5vZGUudGFyZ2V0TGlua3MsIHZhbHVlKTtcbiAgICAgICAgICAgIG5vZGUueSArPSAoeSAtIGNlbnRlcihub2RlKSkgKiBhbHBoYTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIGZ1bmN0aW9uIHdlaWdodGVkU291cmNlKGxpbmspIHtcbiAgICAgICAgcmV0dXJuIGNlbnRlcihsaW5rLnNvdXJjZSkgKiBsaW5rLnZhbHVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIHJlbGF4UmlnaHRUb0xlZnQoYWxwaGEpIHtcbiAgICAgIG5vZGVzQnlCcmVhZHRoLnNsaWNlKCkucmV2ZXJzZSgpLmZvckVhY2goZnVuY3Rpb24obm9kZXMpIHtcbiAgICAgICAgbm9kZXMuZm9yRWFjaChmdW5jdGlvbihub2RlKSB7XG4gICAgICAgICAgaWYgKG5vZGUuc291cmNlTGlua3MubGVuZ3RoKSB7XG4gICAgICAgICAgICB2YXIgeSA9IGQzLnN1bShub2RlLnNvdXJjZUxpbmtzLCB3ZWlnaHRlZFRhcmdldCkgLyBkMy5zdW0obm9kZS5zb3VyY2VMaW5rcywgdmFsdWUpO1xuICAgICAgICAgICAgbm9kZS55ICs9ICh5IC0gY2VudGVyKG5vZGUpKSAqIGFscGhhO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgZnVuY3Rpb24gd2VpZ2h0ZWRUYXJnZXQobGluaykge1xuICAgICAgICByZXR1cm4gY2VudGVyKGxpbmsudGFyZ2V0KSAqIGxpbmsudmFsdWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gcmVzb2x2ZUNvbGxpc2lvbnMoKSB7XG4gICAgICBub2Rlc0J5QnJlYWR0aC5mb3JFYWNoKGZ1bmN0aW9uKG5vZGVzKSB7XG4gICAgICAgIHZhciBub2RlLFxuICAgICAgICAgICAgZHksXG4gICAgICAgICAgICB5MCA9IDAsXG4gICAgICAgICAgICBuID0gbm9kZXMubGVuZ3RoLFxuICAgICAgICAgICAgaTtcblxuICAgICAgICAvLyBQdXNoIGFueSBvdmVybGFwcGluZyBub2RlcyBkb3duLlxuICAgICAgICBub2Rlcy5zb3J0KGFzY2VuZGluZ0RlcHRoKTtcbiAgICAgICAgZm9yIChpID0gMDsgaSA8IG47ICsraSkge1xuICAgICAgICAgIG5vZGUgPSBub2Rlc1tpXTtcbiAgICAgICAgICBkeSA9IHkwIC0gbm9kZS55O1xuICAgICAgICAgIGlmIChkeSA+IDApIG5vZGUueSArPSBkeTtcbiAgICAgICAgICB5MCA9IG5vZGUueSArIG5vZGUuZHkgKyBub2RlU3BhY2luZztcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIElmIHRoZSBib3R0b21tb3N0IG5vZGUgZ29lcyBvdXRzaWRlIHRoZSBib3VuZHMsIHB1c2ggaXQgYmFjayB1cC5cbiAgICAgICAgZHkgPSB5MCAtIG5vZGVTcGFjaW5nIC0gc2l6ZVsxXTtcbiAgICAgICAgaWYgKGR5ID4gMCkge1xuICAgICAgICAgIHkwID0gbm9kZS55IC09IGR5O1xuXG4gICAgICAgICAgLy8gUHVzaCBhbnkgb3ZlcmxhcHBpbmcgbm9kZXMgYmFjayB1cC5cbiAgICAgICAgICBmb3IgKGkgPSBuIC0gMjsgaSA+PSAwOyAtLWkpIHtcbiAgICAgICAgICAgIG5vZGUgPSBub2Rlc1tpXTtcbiAgICAgICAgICAgIGR5ID0gbm9kZS55ICsgbm9kZS5keSArIG5vZGVTcGFjaW5nIC0geTA7XG4gICAgICAgICAgICBpZiAoZHkgPiAwKSBub2RlLnkgLT0gZHk7XG4gICAgICAgICAgICB5MCA9IG5vZGUueTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGFzY2VuZGluZ0RlcHRoKGEsIGIpIHtcbiAgICAgIHJldHVybiBhLnkgLSBiLnk7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gY29tcHV0ZUxpbmtEZXB0aHMoKSB7XG4gICAgbm9kZXMuZm9yRWFjaChmdW5jdGlvbihub2RlKSB7XG4gICAgICBub2RlLnNvdXJjZUxpbmtzLnNvcnQoYXNjZW5kaW5nVGFyZ2V0RGVwdGgpO1xuICAgICAgbm9kZS50YXJnZXRMaW5rcy5zb3J0KGFzY2VuZGluZ1NvdXJjZURlcHRoKTtcbiAgICB9KTtcbiAgICBub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHtcbiAgICAgIHZhciBzeSA9IDAsIHR5ID0gMDtcbiAgICAgIG5vZGUuc291cmNlTGlua3MuZm9yRWFjaChmdW5jdGlvbihsaW5rKSB7XG4gICAgICAgIGxpbmsuc3kgPSBzeTtcbiAgICAgICAgc3kgKz0gbGluay5keTtcbiAgICAgIH0pO1xuICAgICAgbm9kZS50YXJnZXRMaW5rcy5mb3JFYWNoKGZ1bmN0aW9uKGxpbmspIHtcbiAgICAgICAgbGluay50eSA9IHR5O1xuICAgICAgICB0eSArPSBsaW5rLmR5O1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBmdW5jdGlvbiBhc2NlbmRpbmdTb3VyY2VEZXB0aChhLCBiKSB7XG4gICAgICByZXR1cm4gYS5zb3VyY2UueSAtIGIuc291cmNlLnk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gYXNjZW5kaW5nVGFyZ2V0RGVwdGgoYSwgYikge1xuICAgICAgcmV0dXJuIGEudGFyZ2V0LnkgLSBiLnRhcmdldC55O1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIGNlbnRlcihub2RlKSB7XG4gICAgcmV0dXJuIG5vZGUueSArIG5vZGUuZHkgLyAyO1xuICB9XG5cbiAgZnVuY3Rpb24gdmFsdWUobGluaykge1xuICAgIHJldHVybiBsaW5rLnZhbHVlO1xuICB9XG5cbiAgcmV0dXJuIHNhbmtleTtcbn07XG4iXX0=
