"use strict";var scaleColorLink=d3.scaleOrdinal().range(["#80A1C1","#BA3F1D","#333333","#643173","#BA3F1D"]),fontScale=d3.scaleLinear().range([8,16]),subtractLight=function t(e,n){var r=parseInt(e,16)-n,a=r<0?0:r;return a=a.toString(16).length>1?a.toString(16):"0"+a.toString(16)},darken=function t(e,n){return e=e.indexOf("#")>=0?e.substring(1,e.length):e,n=parseInt(255*n/100),e="#"+subtractLight(e.substring(0,2),n)+subtractLight(e.substring(2,4),n)+subtractLight(e.substring(4,6),n)};$(function(){var t=$("#content").height(),e=$("#content").width()-$("#placa").width(),n=void 0,r=void 0,a=void 0,o=void 0,i=void 0,s=void 0,c=void 0,u=function t(e,n){var r={top:0,right:0,bottom:0,left:0},a={width:300-r.left-r.right,height:50-r.top-r.bottom},o=["2012","2013","2014","2015","2016","2017"],i=[];e.forEach(function(t,e){i.push({date:new Date(o[e]),value:t})});var s=n.html("").append("svg").attr("width",a.width+r.left+r.right).attr("height",a.height+r.top+r.bottom).append("g").attr("transform","translate("+r.left+", "+r.top+")"),c=d3.scaleTime().domain(d3.extent(i,function(t){return t.date})).rangeRound([0,a.width]),u=d3.scaleLinear().domain(d3.extent(i,function(t){return t.value})).rangeRound([a.height,0]),l=d3.line().x(function(t){return c(t.date)}).y(function(t){return u(t.value)});s.append("g").call(d3.axisBottom(c)).style("transform","translate(0px, "+(a.height-1)+"px)"),s.append("g").call(d3.axisLeft(u)),s.append("path").datum(i).attr("fill","none").attr("stroke","steelblue").attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1.5).attr("d",l)},l=function t(e){var n=d3.select("#placa");n.select(".placa_titulo").style("text-transform","uppercase").text(e.name),n.select(".placa_prod").text(e.value),n.select(".placa_imp").text(.2*e.value),n.select(".placa_exp").text(.1*e.value),n.select(".placa_lost").text(.05*e.value),n.select(".placa_efi").text(100*(e.value-.05*e.value)/e.value),n.select(".placa_more").text(.01*e.value),u(e.prod,n.select(".placa_grafico.grafico_prod")),u(e.imp,n.select(".placa_grafico.grafico_imp")),u(e.exp,n.select(".placa_grafico.grafico_exp"))},d=function t(e){return function(t,n){l(t);var r=[],a=void 0,o=void 0,i=void 0,s=void 0;r.push(t.id),t.sourceLinks.forEach(function(t){r.push(t.target.id)}),t.targetLinks.forEach(function(t){r.push(t.source.id)}),a=d3.selectAll("#sankey .link"),o=a.filter(function(e){return e.source.id!==t.id&&e.target.id!==t.id}),o.transition().style("stroke-opacity",e),i=d3.selectAll("#sankey .node"),s=i.filter(function(t){var e=!1;return r.forEach(function(n){n===t.id&&(e=!0)}),e}),s.select("rect").transition().style("fill",function(t){return darken(scaleColorLink(t.category),20)}),s.select("text").transition().attr("text-anchor","middle").attr("y",-10).attr("x",function(t){return t.dx/2}).text(function(t){return t.name}),s=i.filter(function(t){var e=!0;return r.forEach(function(n){n===t.id&&(e=!1)}),e}),s.transition().style("opacity",e)}},f=function t(n){return function(t,n){var r=[],a=void 0,o=void 0,s=void 0,c=void 0;r.push(t.id),t.sourceLinks.forEach(function(t){r.push(t.target.id)}),t.targetLinks.forEach(function(t){r.push(t.source.id)}),a=d3.selectAll("#sankey .link"),o=a.filter(function(e){return e.source.id!==t.id&&e.target.id!==t.id}),o.transition().style("stroke-opacity",.75),s=d3.selectAll("#sankey .node"),c=s.filter(function(t){var e=!1;return r.forEach(function(n){n===t.id&&(e=!0)}),e}),c.select("rect").transition().style("fill",function(t){return scaleColorLink(t.category)}),c.select("text").transition().attr("text-anchor","end").attr("y",function(t){return t.dy/2}).attr("x",-10).text(function(t){return t.name.length>8?t.name.substring(0,5)+"...":t.name}).filter(function(t){return t.x<e/2}).attr("x",10+i.nodeWidth()).attr("text-anchor","start"),c=s.filter(function(t){var e=!0;return r.forEach(function(n){n===t.id&&(e=!1)}),e}),c.transition().style("opacity",1)}},p=function t(e){console.log(e);var r=d3.select("#placa .agrup").append("div").attr("id",function(){return"node_"+e.id}).attr("class","backButton").on("click",function(t){n[e.id].group?n[e.id].group=!1:n[e.id].group=!0,$("#node_"+e.id).remove(),k()});r.append("span").attr("class","backButton_text").text(e.name),r.append("span").append("i").attr("class","fa fa-times").attr("aria-hidden","true").style("margin-left","10px")},h=function t(e,r,a){function o(t){d3.select(this).attr("transform","translate("+(t.x=Math.max(0,Math.min(l.width-t.dx,d3.event.x)))+", "+(t.y=Math.max(0,Math.min(l.height-t.dy,d3.event.y)))+")"),i.relayout(),h.attr("d",s)}var u={top:50,right:50,bottom:50,left:50},l={width:e-u.left-u.right,height:r-u.top-u.bottom};$("#sankey").empty(),c=d3.select("#sankey").append("svg").attr("width",l.width+u.left+u.right).attr("height",l.height+u.top+u.bottom).append("g").attr("transform","translate("+u.left+", "+u.top+")"),i=d3.sankey().nodeWidth(20).size([l.width,l.height]).nodes(a.nodes).links(a.links).layout(),s=i.link(),fontScale.domain(d3.extent(a.nodes,function(t){return t.value}));var h=c.append("g").attr("id","links").selectAll(".link").data(a.links).enter().append("path").attr("class","link").attr("d",s).style("stroke-width",function(t){return Math.max(1,t.dy)}).style("stroke","silver").style("stroke-opacity",.75).on("mouseover",function(t){d3.select(d3.event.target).style("stroke-opacity",1)}).on("mouseout",function(t){d3.select(d3.event.target).style("stroke-opacity",.75)}).sort(function(t,e){return e.dy-t.dy});h.filter(function(t){return"EXPORTACIONES"===t.target.name||"CONSUMO PROPIO"===t.target.name||"TRANSPORTE"===t.target.name||"PERDIDA"===t.target.name}).style("stroke","#BA3F1D"),h.filter(function(t){return"IMPORTACIONES"===t.source.name}).style("stroke","green");var g=c.append("g").attr("id","nodes").selectAll(".node").data(a.nodes.filter(function(t){return 0!==t.sourceLinks.length||0!==t.targetLinks.length})).enter().append("g").attr("id",function(t){return t.id}).attr("class","node").attr("transform",function(t){return"translate("+t.x+", "+t.y+")"}).call(d3.drag().on("drag",o));g.append("rect").attr("width",i.nodeWidth()).attr("height",function(t){return Math.max(10,t.dy)}).style("fill",function(t){return scaleColorLink(t.category)}).on("mouseover",d(.025)).on("mouseout",f()).on("dblclick",function(t){n[t.id].group?n[t.id].group=!1:n[t.id].group=!0,p(t),k()}),g.append("text").attr("x",-10).attr("text-anchor","end").attr("y",function(t){return t.dy/2}).attr("dy",".35em").style("fill",function(t){return scaleColorLink(t.category)}).style("font-size",function(t){return Math.floor(fontScale(t.value))+"px"}).text(function(t){return t.name.length>8?t.name.substring(0,5)+"...":t.name}).filter(function(t){return t.x<e/2}).attr("x",10+i.nodeWidth()).attr("text-anchor","start"),h.append("title").text(function(t){return t.source.name+" ("+t.source.id+") → "+t.target.name+" ("+t.target.id+") → "+t.value}),g.append("title").text(function(t){return t.name+" ("+t.id+")"})},g=function t(e,n,r,a){var o=function t(e,n){console.log(e),console.log(n);var r=[],a=void 0,o=void 0;return n.forEach(function(t,n){a=t.source,o=t.target,e.forEach(function(t,e){a===t.source.id&&o===t.target.id||r.push(t)})}),r},c={top:0,right:0,bottom:0,left:0},u={width:e-c.left-c.right,height:n-c.top-c.bottom};i=d3.sankey().nodeWidth(20).size([u.width,u.height]).nodes(r.nodes).links(r.links).layout(32),i.relayout(),s=i.link(),$("#links").empty(),d3.select("#links").selectAll(".link").data(r.links).enter().append("path").attr("class","link").attr("d",function(t){return s(t)}).style("stroke-width",function(t){return t.dy}).style("stroke","gray").on("mouseover",function(t){d3.select(d3.event.target).style("stroke","red")}).on("mouseout",function(t){d3.select(d3.event.target).style("stroke","gray")}),d3.selectAll(".node").data(r.nodes).attr("transform",function(t){return"translate("+t.x+", "+t.y+")"}),d3.selectAll("rect").data(r.nodes).style("opacity",0).attr("width",i.nodeWidth()).attr("height",function(t){return t.dy}).transition().style("opacity",1)},v=function t(e){var n=a.filter(function(t){return t.id===e.parent})[0];return e.parent!==!1&&void 0!==n&&n.group===!0?t(a.filter(function(t){return t.id===e.parent})[0]):e},y=function t(){var e=0,n=[],r=void 0;return a.forEach(function(t,a){r=!1,o.forEach(function(n,a){t.id===n.source&&(r=!0,n.source=n.source-e),t.id===n.target&&(r=!0,n.target=n.target-e)}),r||(n.push(a),e++)}),n.reverse().forEach(function(t){a.splice(t,1)}),a},m=function t(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=[],r=void 0,i=void 0,s=void 0,c=void 0,u=void 0,l=void 0,d=void 0,f=void 0,p=void 0,h=void 0;return o.forEach(function(t,e){r=a.filter(function(e){return e.id===parseInt(t.source)})[0],c=a.filter(function(e){return e.id===parseInt(t.target)})[0],i=v(r),u=v(c),s=i.group,l=u.group,f=s?i:r,p=l?u:c,h=parseInt(t.value),d=n.filter(function(t){return t.source===f.id&&t.target===p.id}),0!==d.length?d[0].value+=h:n.push({source:f.id,target:p.id,value:h})}),n},k=function i(){o=$.extend(!0,[],r),a=$.extend(!0,[],n),o=m(),a=y(),h(e,t,{nodes:a,links:o})};!function t(){(function t(){console.log("Se solicitan archivos");var e=function t(e,n){var r=[];switch(e){case"nodos":n.forEach(function(t,e){r.push({id:parseInt(t.id),name:t.name,parent:"null"!==t.parent&&parseInt(t.parent),category:t.category,pos:parseInt(t.position),group:!1,imp:t.importation.split(";").map(function(t){return parseInt(t)}),exp:t.exportation.split(";").map(function(t){return parseInt(t)}),prod:t.production.split(";").map(function(t){return parseInt(t)})})});break;case"links":n.forEach(function(t,e){r.push({source:parseInt(t.source),target:parseInt(t.target),value:parseInt(t.value)})})}return r};return new Promise(function(t){d3.csv("public/src/nodes.csv",function(a){n=e("nodos",a),d3.csv("public/src/links.csv",function(n){r=e("links",n),t()})})})})().then(function(){k()})}()});
//# sourceMappingURL=./app-min.js.map